import os
import webbrowser
from datetime import datetime
import pytz
import pandas as pd
import plotly.express as px
import plotly.io as pio

# ---------------- Load Dataset ----------------
def load_data():
    file_path = "googleplaystore.csv"  # Replace with your CSV path
    df = pd.read_csv(file_path)
    df = df.dropna(subset=['Rating'])
    df['Installs'] = df['Installs'].str.replace('[+,]', '', regex=True).astype(int)
    df['Reviews'] = pd.to_numeric(df['Reviews'], errors='coerce')
    df['Price'] = df['Price'].str.replace('$','').astype(float)
    df['Last Updated'] = pd.to_datetime(df['Last Updated'], errors='coerce')
    
    df['Size'] = df['Size'].replace('Varies with device', '0')
    df['Size'] = df['Size'].str.replace('M','').str.replace('k','').astype(float)
    return df

# ---------------- Generate Interactive Charts ----------------
def generate_charts(df):
    charts = {}

    # Task 1 - Ratings vs Reviews
    top_reviews = df.nlargest(10, 'Reviews')
    fig1 = px.bar(top_reviews, x='App', y='Rating', text='Rating', title='Ratings vs Reviews (Top 10)')
    charts['task1'] = pio.to_html(fig1, full_html=False, include_plotlyjs='cdn')

    # Task 2 - Free vs Paid Apps
    type_counts = df['Type'].value_counts().reset_index()
    type_counts.columns = ['Type','Count']
    fig2 = px.pie(type_counts, names='Type', values='Count', title='Free vs Paid Apps')
    charts['task2'] = pio.to_html(fig2, full_html=False, include_plotlyjs=False)

    # Task 3 - Category Install Distribution
    cat_installs = df.groupby('Category')['Installs'].sum().sort_values(ascending=False).head(10).reset_index()
    fig3 = px.bar(cat_installs, x='Category', y='Installs', title='Top 10 Categories by Installs')
    charts['task3'] = pio.to_html(fig3, full_html=False, include_plotlyjs=False)

    # Task 4 - Cumulative Installs Over Time
    monthly_installs = df.groupby(df['Last Updated'].dt.to_period('M'))['Installs'].sum().reset_index()
    monthly_installs['Last Updated'] = monthly_installs['Last Updated'].astype(str)
    fig4 = px.line(monthly_installs, x='Last Updated', y='Installs', markers=True, title='Cumulative Installs Over Time')
    charts['task4'] = pio.to_html(fig4, full_html=False, include_plotlyjs=False)

    # Task 5 - App Size vs Rating Bubble Chart
    fig5 = px.scatter(df, x='Size', y='Rating', size='Size', hover_data=['App'], color='Rating', color_continuous_scale='Viridis', title='App Size vs Rating Bubble Chart')
    charts['task5'] = pio.to_html(fig5, full_html=False, include_plotlyjs=False)

    # Task 6 - Total Installs Trend
    daily_installs = df.groupby(df['Last Updated'].dt.date)['Installs'].sum().reset_index()
    fig6 = px.line(daily_installs, x='Last Updated', y='Installs', markers=True, title='Total Installs Trend')
    charts['task6'] = pio.to_html(fig6, full_html=False, include_plotlyjs=False)

    return charts

# ---------------- Build Dashboard ----------------
def open_dashboard():
    tz = pytz.timezone("Asia/Kolkata")
    now = datetime.now(tz)
    current_hour = now.hour

    df = load_data()
    charts = generate_charts(df)

    html = f"""
    <!DOCTYPE html>
    <html>
    <head>
        <meta charset="UTF-8">
        <title>Google Play Store Analytics Dashboard</title>
        <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
        <style>
            body{{font-family: Arial, sans-serif; margin:20px; background:#f9f9f9;}}
            .header{{display:flex; align-items:center; justify-content:center; gap:15px; margin-bottom:30px;}}
            .header img{{height:40px;}}
            h1{{font-size:24px; margin:0;}}
            .task{{margin-bottom:50px; padding:15px; background:white; border-radius:8px; box-shadow:0 2px 6px rgba(0,0,0,0.1);}}
            .warning{{color:red; font-weight:bold; margin-top:10px;}}
        </style>
    </head>
    <body>
        <div class="header">
            <img src="https://upload.wikimedia.org/wikipedia/commons/7/78/Google_Play_Store_badge_EN.svg">
            <h1>Google Play Store Analytics Dashboard</h1>
        </div>
    """

    # Task 1 - Always visible
    html += f"""
    <div class="task">
        <h2>Task 1 – Ratings vs Reviews</h2>
        {charts['task1']}
    </div>
    """

    # Task 2 - 1PM–2PM
    if 13 <= current_hour < 14:
        html += f"""
        <div class="task">
            <h2>Task 2 – Free vs Paid Apps</h2>
            {charts['task2']}
        </div>
        """
    else:
        html += """
        <div class="task">
            <h2>Task 2 – Free vs Paid Apps</h2>
            <div class="warning">Available only between 1 PM and 2 PM IST.</div>
        </div>
        """

    # Task 3 - 6PM–8PM
    if 18 <= current_hour < 20:
        html += f"""
        <div class="task">
            <h2>Task 3 – Category Install Distribution</h2>
            {charts['task3']}
        </div>
        """
    else:
        html += """
        <div class="task">
            <h2>Task 3 – Category Install Distribution</h2>
            <div class="warning">Available only between 6 PM and 8 PM IST.</div>
        </div>
        """

    # Task 4 - 4PM–6PM
    if 16 <= current_hour < 18:
        html += f"""
        <div class="task">
            <h2>Task 4 – Cumulative Installs Over Time</h2>
            {charts['task4']}
        </div>
        """
    else:
        html += """
        <div class="task">
            <h2>Task 4 – Cumulative Installs Over Time</h2>
            <div class="warning">Available only between 4 PM and 6 PM IST.</div>
        </div>
        """

    # Task 5 - 5PM–7PM
    if 17 <= current_hour < 19:
        html += f"""
        <div class="task">
            <h2>Task 5 – App Size vs Rating Bubble Chart</h2>
            {charts['task5']}
        </div>
        """
    else:
        html += """
        <div class="task">
            <h2>Task 5 – App Size vs Rating Bubble Chart</h2>
            <div class="warning">Available only between 5 PM and 7 PM IST.</div>
        </div>
        """

    # Task 6 - 6PM–9PM
    if 18 <= current_hour < 21:
        html += f"""
        <div class="task">
            <h2>Task 6 – Total Installs Trend</h2>
            {charts['task6']}
        </div>
        """
    else:
        html += """
        <div class="task">
            <h2>Task 6 – Total Installs Trend</h2>
            <div class="warning">Available only between 6 PM and 9 PM IST.</div>
        </div>
        """

    html += "</body></html>"

    # Save as index.html
    file_name = "index.html"
    with open(file_name, "w", encoding="utf-8") as f:
        f.write(html)

    webbrowser.open("file://" + os.path.abspath(file_name))

# ---------------- Run ----------------
open_dashboard()
